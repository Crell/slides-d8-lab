<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">

    <title>Drupal 8 Essentials by Palantir.net</title>

    <meta name="author" content="Larry Garfield, Ken Rickard, Robin Barre">

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="css/palantir-reveal.css">
    <link rel="stylesheet" href="css/theme/palantir.css" id="theme">

    <!-- For syntax highlighting -->
    <link rel="stylesheet" href="lib/css/palantir-zenburn.css">

    <!-- If the query includes 'print-pdf', use the PDF print sheet -->
    <script>
      document.write( '<link rel="stylesheet" href="css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
    </script>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
  </head>

  <body>

    <div class="reveal">

      <!-- Any section element inside of this container is displayed as a slide -->
      <div class="slides">


        <!-- KEN'S INTRODUCTORY SLIDES -->
        <section>
          <section>
            <h1>Welcome</h1>
            <h2>Palantir.net</h2>
            <h2>Drupal 8 Development</h2>
          </section>

          <section>
            <h1>Trainers</h1>
            <h2>Robin Barre</h2>
            <h2>Larry Garfield</h2>
            <h2>Ken Rickard</h2>
          </section>
          <section>
            <h1>Introductions</h1>
            <ul>
              <li class="fragment">Your name</li>
              <li class="fragment">Where you're from</li>
              <li class="fragment">What one thing do you want to accomplish?</li>
            </ul>
          </section>
          <section>
            <h1>Goals</h1>
            <h3>SWBAT*</h3>
            <ul>
              <li class="fragment">Trace the path of a Drupal request and response</li>
              <li class="fragment">Create routes and controllers for requests</li>
              <li class="fragment">Define common module plugins</li>
              <li class="fragment">Store default module settings</li>
              <li class="fragment">Create forms and pages</li>
              <li class="fragment">Create tests with SimpleTest and PHPUnit</li>
            </ul>
          </section>

          <section>
            <h1>Outline</h1>
            <ul>
              <li class="fragment">Drupal 8 for site builders</li>
              <li class="fragment">New concepts from PHP</li>
              <li class="fragment">Architecture overview</li>
              <li class="fragment">Drupal 8 building blocks</li>
              <li class="fragment">Testing</li>
            </ul>
          </section>

          <section>
            <h1>Process</h1>
            <ul>
              <li class="fragment">Introduction to concepts</li>
              <li class="fragment">Examples in code</li>
              <li class="fragment">Practical activity</li>
              <li class="fragment">Peer review</li>
            </ul>
          </section>

          <section>
            <h1>Demo time!</h1>
          </section>
        </section>

        <section>
          <section>
            <h1>Understanding Drupal 8</h1>
          </section>
          <section>
            <h2>Drupal 7</h2>
            <h3>PHP 4 application</h3>
          </section>

          <section>
            <h2>Drupal 8</h2>
            <h3>PHP 5.3 application</h3>
            <p class="fragment">We ported Drupal to a new language</p>
          </section>

          <section>
            <h2>What does that mean?</h2>
            <ul>
              <li class="fragment">The end of "Not Invented Here"</li>
              <li class="fragment">We have catching up to do</li>
            </ul>
          </section>

          <section>
            <h2>Playing nice with others</h2>
            <ul>
              <li class="fragment">Namespacing</li>
              <li class="fragment">Interfaces</li>
              <li class="fragment">Annotations</li>
              <li class="fragment">Plugins</li>
              <li class="fragment">YAML</li>
            </ul>
          </section>

          <section>
            <h2>Namespacing</h2>
            <ul>
              <li class="fragment">PSR-0
              <li class="fragment">A fully-qualified namespace and class must have the following structure:<br />
              <code>\&lt;Vendor Name&gt;\(&lt;Namespace&gt;)*\&lt;Class Name&gt;</code></li>
              <li class="fragment">Allows standard autoloading</li>
              <li class="fragment">See <a href="https://github.com/php-fig/fig-standards">https://github.com/php-fig/fig-standards</a></li>
            </ul>
          </section>

          <section>
            <pre><code class="php">/**
 * @file
 * Definition of Drupal\domain\Plugin\Core\Entity\Domain.
 */

namespace Drupal\domain\Plugin\Core\Entity;

use Drupal\domain\DomainInterface;
use Drupal\Core\Entity\ContentEntityInterface;
use Drupal\Core\Entity\Entity;
use Drupal\Core\Entity\Annotation\EntityType;
use Drupal\Core\Entity\EntityStorageControllerInterface;
use Drupal\Core\Annotation\Translation;
use Guzzle\Http\Exception\HttpException</code></pre>
          </section>

          <section>
            <h2>Interfaces</h2>
            <ul>
              <li class="fragment">Separate design from implementation</li>
              <li class="fragment">Allow objects to be mocked (testable)</li>
              <li class="fragment">Allow implementations to be swapped</li>
              <li class="fragment">Separate your library code from your Drupal code</li>
            </ul>
          </section>

          <section>
            <pre><code class="php">/**
 * @file
 * Definition of Drupal\domain\DomainInterface.
 */

namespace Drupal\domain;
use Drupal\Core\Entity\ContentEntityInterface;

interface DomainInterface extends ContentEntityInterface {

  public function validate();
  public function checkResponse();
  public function isActive();
  public function isDefault();

}</code></pre>
          </section>

          <section>
            <h2>Annotations</h2>
            <ul>
              <li class="fragment">Docblocks as class definitions</li>
              <li class="fragment">Self-documenting</li>
              <li class="fragment">Replaces custom <code>hook_*_info()</code></li>
            </ul>
          </section>

          <section>
            <pre><code class="php">namespace Drupal\domain\Plugin\Block;
use Drupal\block\BlockBase;
use Drupal\Component\Annotation\Plugin;
use Drupal\Core\Annotation\Translation;

/**
 * Provides a server information block for a domain request.
 *
 * @Plugin(
 *   id = "domain_server_block",
 *   admin_label = @Translation("Domain server information"),
 *   module = "domain"
 * )
 */
class DomainServerBlock extends BlockBase {

}</code></pre>
          </section>

          <section>
            <h2>Plugins</h2>
            <ul>
              <li class="fragment">Generic term for a code model</li>
              <li class="fragment">Separation of concerns</li>
              <li class="fragment">Autoloading</li>
              <li class="fragment">Encourages libraries</li>
              <li class="fragment">See Views module in Drupal 7</li>
            </ul>
          </section>

          <section>
            <pre><code class="php">class DomainServerBlock extends BlockBase {
  /**
   * Overrides \Drupal\block\BlockBase::access().
   */
  public function access() {
    Drupal::request()->attributes->get('_account')
      ->hasPermission('access content');
  }

  /**
   * Build the output.
   */
  public function build() {
    return 'foo';
  }
}</code></pre>
          </section>

          <section>
            <h2>YAML*</h2>
            <p><small>* Yes, this isn't a PHP thing</small></p>
            <ul>
              <li class="fragment">Generic syntax for complex data</li>
              <li class="fragment">Portable</li>
              <li class="fragment">Core of the CMI</li>
            </ul>
          </section>

          <section>
            <h2>module.info.yml</h2>
           <pre><code class="yaml">name: Domain
description: 'Creates domain records within a Drupal installation.'
type: module
package: Domain
version: VERSION
core: 8.x
dependencies:
  - options
  - entity_reference
configure: admin/structure/domain</code></pre>
          </section>

          <section>
          <h2>module.routing.yml</h2>
          <pre><code class="yaml long_code">domain_admin:
  pattern: 'admin/structure/domain'
  defaults:
    _content: '\Drupal\domain\Controller\DomainController::adminOverview'
  requirements:
    _permission: 'administer domains'</code></pre>
          </section>

          <section>
            <h2>views.view.module.<br />view_name.yml</h2>
            <pre><code class="yaml">base_field: domain_id
base_table: domain
core: 8.x
description: ''
status: '1'
display:
  default:
    display_plugin: default
    id: default
    display_title: Master
    position: ''
    display_options:
      access:
        type: perm
        options:
          perm: 'administer domains'
      cache:
        type: none
      query:
        type: views_query</code></pre>
          </section>

          <section>
            <h1>Lots of changes</h1>
          </section>

          <section>
            <h2>Module structure</h2>
            <pre><code>
mymodule/
  mymodule.info.yml
  mymodule.module
  mymodule.routing.yml
    lib/
      Drupal/
        Controller/
          MyModuleController.php
        Plugin/
          Action/
            MyModuleCreateRainbows.php
            MyModuleGetPuppies.php
          Block/
            MyModuleHelloWorldBlock.php
            MyModuleGoodbyeCruelWorldBlock.php</code></pre>
          </section>

          <section>
            <h2 style="color: #a31; font-size: 256px; text-shadow: 1px 1px 1px #800;">Don't Panic</h2>
          </section>

        </section>
        <!-- // KEN'S INTRODUCTORY SLIDES -->

        <section>
          <section>
            <h1>Understanding the web</h1>
          </section>
          <section>
            <h3>PHP 4 architecture</h3>
            <img src="img/architecture-php4.svg"  class="graphic" />
          </section>
          <section>
            <h3>HTTP Architecture</h3>
            <img src="img/architecture-http.svg" class="graphic"/>
          </section>
          <section>
            <h3>Symfony/HttpKernel architecture</h3>
            <img src="img/architecture-httpkernelinterface.svg" class="graphic"/>
          </section>
          <section>
            <pre class="long_code"><code class="php">interface HttpKernelInterface {
  const MASTER_REQUEST = 1;
  const SUB_REQUEST = 2;

  /**
   * Handles a Request to convert it to a Response.
   *
   * @param Request $request A Request instance
   * @param integer $type    The type of the request
   * @param Boolean $catch Whether to catch exceptions or not
   *
   * @return Response A Response instance
   */
  public function handle(Request $request, $type = self::MASTER_REQUEST, $catch = true);
}
            </code></pre>
          </section>
          <section>
            <h3>HttpKernel pipeline</h3>
            <img src="img/architecture-httpkernel.svg" class="graphic"/>
          </section>
        </section>
        <section>
          <section>
            <h2>Controllers</h2>
            <p class="fragment roll-in">(The concept formerly known as page callbacks and now represented by a PHP callable...)</p>
          </section>
          <section>
            <pre><code class="php">use Symfony\Component\HttpFoundation\Response;

class MyControllers {

  public function hello() {
    return new Response('&lt;html>&lt;body>Hello World&lt;/body>&lt;/html>');
  }
}
</code></pre>
          </section>
          <section>
            <pre><code class="php">use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\HttpFoundation\JsonResponse;

class MyControllers {

  public function hello() {
    return new Response('&lt;html>&lt;body>Hello World&lt;/body>&lt;/html>');
  }

  public function helloJson() {
    $data['Hello'] = 'World';
    return new JsonResponse($data);
  }
}
</code></pre>
          </section>
          <section>
            <pre><code class="php">use Symfony\Component\HttpFoundation\StreamedResponse;

class MyControllers {

  public function helloStream() {
    $response = new StreamedResponse();
    $response->setCallback(function () {
      echo 'Hello World';
      flush();
      sleep(2);
      echo 'Hello Universe';
      flush();
    });
  }
}
</code></pre>
            <aside class="notes">
              Segue: The most common example is just returning a file off disk...
            </aside>
          </section>
          <section>
            <pre><code class="php">use Symfony\Component\HttpFoundation\BinaryFileResponse;

class MyControllers {

  public function helloFile() {
    $response = new BinaryFileResponse('hello_world.png');

    // Do this in settings.php if you know you're on nginx or
    // have the Apache module enabled.
    $response::trustXSendfileTypeHeader();

    return $response;
  }
}
</code></pre>
            <aside class="notes">
              Drupalers wrote that. :-)
            </aside>

          </section>
          <section>
            <pre><code class="php">use Symfony\Component\HttpFoundation\Response;

class MyControllers {

  public function helloEmpty() {
    $this->doSomething();

    $response = new Response();
    $response->setStatusCode(204);
    return $response;
  }
}
</code></pre>
          </section>
          <section>
            <pre><code class="php">use Symfony\Component\HttpFoundation\Response;

class MyControllers {

  public function helloCsv() {
    foreach ($some_data as $record) {
      $lines[] = implode(', ', $record);
    }

    $response = new Response(implode("\n", $lines));
    $response->headers->set('Content-Type', 'text/csv');
    return $response;
  }
}
</code></pre>
            <aside class="notes">
              <ul>
                <li>Tip: Could we combine this with a StreamedResponse to send records on the fly? How?</li>
              </ul>
            </aside>
          </section>
          <section>
            <pre><code class="php">use Symfony\Component\HttpFoundation\Response;

class MyControllers {

  public function helloCoffee() {
    if ($this->isTeapot()) {
      $response = new Response("Don't put coffee in me", 418);
      return $response;
    }

    // ...
  }
}
</code></pre>
          </section>
          <section>
            <pre><code class="php">class MyControllers {

  public function helloString() {
    return "The view event will turn this into a response.";
  }
}
</code></pre>
          </section>
          <section>
            <pre><code class="php">class MyControllers {

  public function helloDrupal() {
    return array(
      '#theme' => 'a_drupal_render_array',
      '#description' => 'Those still exist.',
    );
  }
}
</code></pre>
          </section>
          <section>
            <code>/hello/world/{from}/{to}</code>
            <pre><code class="php">class MyControllers {

  public function helloDrupal($to, $from, Request $request) {
    return array(
      '#theme' => 'love_letter',
      '#from' => $from,
      '#to' => $to,
    );
  }
}
</code></pre>
          </section>
          <section>
          <h3>module.routing.yml</h3>
          <pre><code class="yaml long_code">hello.world:
  pattern: '/hello/world/{from}/{to}'
  defaults:
    _content: '\Drupal\mymodule\Controller\HelloController::helloWorld'
  requirements:
    _permission: 'access content'
    from: \s+
    to: \s+
</code></pre>
          </section>

          <section>
            <h1>Your turn!</h1>
            <p><a href="https://github.com/palantirnet/hellodrupal">https://github.com/palantirnet/hellodrupal</a></p>
            <aside class="notes">
              Your task is to write 3 simple controllers.
              One returns the string "hello world", as a Drupal page.
              One returns a JSON string that says hello world.
              One accepts a name from the path and says "Hello $name", using
              a template.
          </section>
        </section>

        <section>
          <section>
            <h2>Routing</h2>
            <p class="fragment">(You don't need to know every detail of this.)</p>
            <aside class="notes">
              <ul>
                <li>This is mostly to show the thought process.</li>
                <li>Lots of little pieces working together.</li>
                <li>Swap them out individually.</li>
              </ul>
            </aside>
          </section>
          <section>
            <h2>It's all listeners</h2>
            <p>KernelEvents::REQUEST</p>
            <aside class="notes">
              <ul>
                <li>Think of it as hook_request_alter(). Kinda.</li>
                <li>"Stuff that happens before the controller."</li>
              </ul>
            </aside>
          </section>
          <section>
            <h3>Routing</h3>
            <img src="img/routing.svg" />
          </section>
          <section>
            <h3>Dynamic Router</h3>
            <img src="img/dynamic-router.svg" />
          </section>
          <section>
            <h2>Route Enhancers</h2>
            <pre><code class="php">class ContentControllerEnhancer implements RouteEnhancerInterface {
  protected $types = array(
    'drupal_dialog' => 'controller.dialog:dialog',
    'drupal_modal' => 'controller.dialog:modal',
    'html' => 'controller.page:content',
  );

  public function enhance(array $defaults, Request $request) {
    if (empty($defaults['_controller']) && !empty($defaults['_content'])) {
      $type = $this->negotiation->getContentType($request);
      if (isset($this->types[$type])) {
        $defaults['_controller'] = $this->types[$type];
      }
    }
    return $defaults;
  }
}
</code></pre>
          </section>
          <section>
            <h3>Access control</h3>
            <p class="fragment">Authentication vs. Authorization</p>
            <p class="fragment">(Yep, more listeners)</p>
            <aside class="notes">
              <ul>
                <li>Authentication: Who are you?</li>
                <li>Authorization: Are you allowed to do that?</li>
                <li>Mostly you'll deal with Authorization.</li>
              </ul>
            </aside>
          </section>
          <section>
            <h3>Authentication</h3>
            <p class="fragment">global $user is dead</p>
            <p class="fragment">Long live<br /><code>$request->attributes->get('_account')</code></p>
          </section>
          <section>
            <h3>Access control</h3>
            <ul>
              <li class="fragment">Multiple "checkers" per route</li>
              <li class="fragment">Applies or not</li>
              <li class="fragment">Allow, Deny, Kill</li>
              <li class="fragment">Any vs. All</li>
            </ul>
          </section>
          <section>
            <h2>Route with access</h2>
            <pre><code class="yaml">comment_edit_page:
  pattern: '/comment/{comment}/edit'
  defaults:
    _entity_form: 'comment.default'
  options:
    _access_mode: 'ANY'
  requirements:
    _entity_access: 'comment.update'
    _permission: 'edit any comment'
</code></pre>
          </section>

          <section>
            <h2>Permission check</h2>
            <pre class="long_code"><code class="php">class PermissionAccessCheck implements StaticAccessCheckInterface {
  public function appliesTo() {
    return array('_permission');
  }

  public function access(Route $route, Request $request) {
    $permission = $route->getRequirement('_permission');
    $account = $request->attributes->get('_account');
    return $account->hasPermission($permission) ? static::ALLOW : static::DENY;
  }
}
</code></pre>
          </section>
        </section>

        <section>
          <section>
            <h2>Dependency Injection</h2>
            <h3 class="fragment roll-in">It's way less scary than it sounds</h3>
          </section>

          <section>
            <h3>Dependency</h3>
            <p>An object on which your object depends</p>
          </section>
          <section>
            <h3>Service</h3>
            <p>A generally-stateless "global" object</p>
            <aside class="notes">
              <ul>
                <li>Stateless in the sense that once configured, it's idempotent.</li>
                <li>Globalness is not the object's job to enforce. It's the Container's job</li>
              </ul>
            </aside>
          </section>
          <section>
            <pre><code class="php">
class Status {
  public function show() {
    $status = db_query('SELECT status from {table}')->fetchOne();
    return $status;
  }
}

$status = new Status();
print $status->show();
</code></pre>
            <aside class="notes">
              <ul>
                <li>How do you test that? Depends on DB connection, can't control it.</li>
                <li>Need the function, need the DB fully configured and prepped... ugh.</li>
              </ul>
            </aside>
          </section>
          <section>
            <pre><code class="php">
class Status {
  protected $db;

  pubic function __construct(DatabaseInterface $db) {
    $this->db = $db;
  }

  public function show() {
    $status = $this->db->query('SELECT status from {table}')->fetchOne();
    return $status;
  }
}

$db = new Database();
$status = new Status($db);
print $status->show();
</code></pre>
            <aside class="notes">
              <ul>
                <li>Depend on interfaces, not concrete classes.</li>
                <li>Concrete class = still tightly coupled.</li>
              </ul>
            </aside>
          </section>
          <section>
            <pre><code class="php">
class Status {
  protected $db;

  pubic function __construct(DatabaseInterface $db) {
    $this->db = $db;
  }

  public function show() {
    $status = $this->db->query('SELECT status from {table}')->fetchOne();
    return $status;
  }
}

$db = new Database();
$status = new Status($db);
print $status->show();
</code></pre>
            <aside class="notes">
              <ul>
                <li>Now I can fake the database!</li>
                <li>How do I configure the database?</li>
              </ul>
            </aside>
          </section>
          <section>
            <pre><code class="php">
class Status {
  protected $db;

  pubic function __construct(Database $db) {
    $this->db = $db;
  }

  public function show() {
    $status = $this->db->query('SELECT status from {table}')->fetchOne();
    return $status;
  }
}

$db_settings = array(...);
$db = new Database($db_settings);
$status = new Status($db);
print $status->show();
</code></pre>
            <aside class="notes">
              <ul>
                <li>Starting to get ugly...</li>
              </ul>
            </aside>
          </section>
          <section>
            <h3>Dependency Injection "Container"</h3>
            <p class="fragment">"Place where you wire that stuff up in advance"</p>
            <p class="fragment">"Scariest possible name for an array of objects"</p>
            <pre class="fragment"><code class="long_code php">
$status = $container->get('status');
print $status->show();

</code></pre>
            <aside class="notes">
              <ul>
                <li>Container sees that "status" means the Status class</li>
                <li>Container sees Status service has a "dependency" on the DB</li>
                <li>Container creates the DB</li>
                <li>Container creates Status using the DB</li>
                <li>Container returns Status</li>
                <li>Neither Status or the DB are the wiser!</li>
              </ul>
            </aside>
          </section>
          <section>
            <h3>Dependency Injection Container</h3>
            <ul>
              <li class="fragment">You'll <em>almost</em> never interact with it directly</li>
              <li class="fragment">Configure via... YAML</li>
              <li class="fragment">Your classes <em>should not</em> know about it</li>
              <li class="fragment">Focus on testability and swappability</li>
            </ul>
          </section>
          <section>
            <h3>core.services.yml</h3>
             <pre class="fragment long_code"><code class="yaml">services:
  router.dynamic:
    class: Symfony\Cmf\Component\Routing\DynamicRouter
    arguments: ['@router.request_context', '@router.matcher', '@url_generator']
  legacy_url_matcher:
    class: Drupal\Core\LegacyUrlMatcher
  legacy_router:
    class: Symfony\Cmf\Component\Routing\DynamicRouter
    arguments: ['@router.request_context', '@legacy_url_matcher', '@legacy_generator']
  router:
    class: Symfony\Cmf\Component\Routing\ChainRouter
    calls:
      - [setContext, ['@router.request_context']]
      - [add, ['@router.dynamic']]
      - [add, ['@legacy_router']]</code></pre>
            <pre class="fragment"><code class="php">
public function createRouter() {
  $router = new \Symfony\Cmf\Component\Routing\ChainRouter(
    $this->createDynamicRouter(),
    $this->createLegacyRouter()
  );
  $router->setContext($this->createRouterRequestContext());
  $router->add($router_dynamic);
  $router->add($legacy_router);
  return $router;
}
</code></pre>
            <aside class="notes">
              <ul>
                <li>Start with router...</li>
                <li>Generated code is a bit different, but close.</li>
                <li>None of these object know about it</li>
                <li>Each tested in isolation</li>
              </ul>
            </aside>
          </section>
        </section>

<!-- Robin's Plugins Slides -->
        <section>
          <section>
            <h2>Plugins</h2>
            <aside class="notes">
                (hit 's' on your keyboard to see me.)
                What is a plugin?
            </aside>
          </section>
          <section>
            <h3>Plugins</h3>
            <p>A narrow set of functionality</p>
            <hr/>
            <h3>Plugin Systems</h3>
            <p>allows customization and extension of the original system</p>
            <ul>
              <li>e.g. graphics software: processing image files</li>
            </ul>
            <hr/>
            <p>In Drupal 7?</p>
            <aside class="notes">
            in general plugins provide a narrow set of functionality<br/>
            a plugin framework or system allows customization and extension of the original system
            examples outside of drupal<br/>
            graphics software use plugins to apply filters and other processes to an image (photoshop) file<br/>
            web browsers use plugins for playing video and java apps<br/>
            in d7 we have most notably ctools plugins<br/>
            who knows of any other plugin systems in D7? jquery plugins? others?<br/>
            </aside>
          </section>
          <section>
            <h2>One plugin system<br/>to rule them all!</h2>
            <p>a new universal plugin system supports:</p>
            <ol>
              <li>plugin types</li>
              <li>plugin discovery</li>
              <li>plugin factory</li>
            </ol>
            <p>Managers define and manage</p>
            <aside class="notes">
            <p>Drupal 8 One plugin system to rule them all!</p>
              <p>in d8, we have a new universal plugin system available via core.
                This system has three base elements:</p>
              <ol>
                <li>plugin types - a controlling class that defines how plugins will be discovered and instantiated. plugin types are the OO solution for info hooks.</li>
                <li>plugin discovery - finds plugins in the code base to apply</li>
                <li>plugin factory - instantiates specific plugins as needed</li>
              </ol>
              each type of plugin has a manager that defines and controls three of these things<br/>
              e.g. BlockManager, ArchiverManager, EditorManager
              <p>(maybe) other components that could be useful:
              plugin derivatives, discovery decorators and plugin mappers.</p>
            </aside>
          </section>
          <section>
            <h2>Plugin Types</h2>
            <ul>
              <li>Blocks</li>
              <li>Actions</li>
              <li>Views</li>
              <li>[field]Formatters</li>
            </ul>
            <p>Example of a block plugin</p>
            <pre><code class="php fragment">
/* Annotation */
class HelloBlock extends BlockBase {

  public function settings() {  }

  public function blockForm($form, &$form_state) {  }

  public function blockSubmit($form, &$form_state) {  }

  public function build() {  }
}
            </code></pre>

            <aside class="notes">
        plugin types<br/>
        Some examples:  blocks, actions, views (field)Formatters.  Sound familiar?<br/>
        let's see an example
            </aside>
          </section>
          <section>
            <h2>What is Plugin &quot;Discovery&quot;?</h2>
            <p>find plugins, metadata</p>
            <p>parse plugin metadata</p>
            <p>use annotated class discovery<p>
            <pre><code class="php fragment rollin">
modulename/
  lib/
    Drupal/
      modulename/
        Plugin/
          plugintype/
            pluginname.php
---

action/
  lib/
    Drupal/
      action/
        Plugin/
          Action/
            EmailAction.php
            </code></pre>
            <aside class="notes">
              designed to replace info hooks<br/>
              finds plugins, finds metadata and parses it<br/>
              takes returned metadata and instantiates objects(factory)<br/>
              annotated class discovery - use this one<br/>
              plugins are all located in the same place no matter if it's a core module or contrib<br/>
              other types of discovery:<br/>
              discovery - uses module_invoke_all (don't use this, support for legacy code)<br/>
              static discovery - mostly used for tests, not intelligent<br/>
            </aside>
          </section>
          <section>
            <h2>Metadata</h2>
            <p>Annotations provide the metadata</p>
            <p>Annotation Types e.g.  EntityType, ActionType
            <pre><code class="php">
use Drupal\Component\Annotation\Plugin; /* required */

/**
* @Plugin(
*   ...
* )
*/
            </code></pre>
            <p>Appears just above your plugin class</p>
          </section>
          <section>
            <h2>Annotations</h2>
            <ul>
              <li>key-value data structures with nesting support</li>
            </ul>
            <pre><code class="php">
/**
* Provides a  hello block.
*
* @Plugin(
*  id = "hellodrupal_hello",
*  admin_label = @Translation("Hello World"),
*  module = "hellodrupal"
* )
*/
            </code></pre>
            <ul>
              <li>what key-value pairs? check the  annotation type class:</li>
            </ul>
            <p style="font-size:.5em"><code>core/lib/Drupal/core/Entity/Annotations/EntityType.php</code></p>
            <aside class="notes">
              a bit about annotations in general<br/>
          </section>
          <section>
            <h2>Annotation Tips</h2>
            <ul>
              <li>id = machine_name</li>
              <li>Always use double quotes</li>
              <li>Strings must use quotes</li>
              <li>Numbers and Booleans must NOT use quotes</li>
              <li>No trailing commas!</li>
              <li>Doctrine:  http://docs.doctrine-project.org/en/2.0.x/reference/annotations-reference.html</li>
            </ul>
            <pre><code class="php">
/**
* Provides a  hello block.
*
* @Plugin(
*  id = "hellodrupal_hello",
*  admin_label = @Translation("Hello World"),
*  module = "hellodrupal"
* )
*/
            </code></pre>
            <aside class="notes">
              annotations are inherently key-value data structures, with support for nesting.<br/>
              Single quotes throw an exception.<br/>
            </aside>
          </section>
          <section>
            <h2>Drupal 7 to Drupal 8</h2>
            <ul>
              <li>plugin types replace D7 hooks (info hooks)</li>
              <li><strike>switch statement in hook_block_view</strike></li>
              <li>a block is its own class in D8</li>
              <li>hook_block_view is now BlockBase::blockBuild</li>
            </ul>
            <aside class="notes">
              plugin types replace old hooks especially info hooks.<br/>
              see hook_block_info, hook_bloc_save, hook_block_view are enacpsulated in one plugin<br/>
              no more switch statements like you used to do in hook_block_view  <br/>
              hook_block_view is now the build()<br/>
              and each custom block is its own class extending BlockBase.<br/>
              see BlockPluginInterface to find all of the methods you might use.<br/>
            </aside>
          </section>
          <section>
            <h4>Now you try!</h4>
            <ul>
              <li>HelloBlock.php</li>
              <li>Set the metadata (in Annotations)</li>
            <pre class="fragment"><code class="php">
/**
* Provides a hello block.
*
* @Plugin(
*  id = "hellodrupal_hello",
*  admin_label = @Translation("Hello World"),
*  module = "hellodrupal"
* )
*/
            </code></pre>
              <li>pull in settings</li>
            </ul>
            <pre class="fragment"><code class="php">
public function settings() {
  return array(
    'person' => 'World',
  );
}
            </code></pre>
            <aside class="notes">
              introduce HelloBlock from the UI<br/>
              find HelloBlock.php<br/>
              add metadata via Annotations<br/>
              allow settings<br/>
              alter the block form<br/>
              alter the submit<br/>
              create a render array<br/>
              create a template file<br/>
              notify theme layer about our new template<br/>
            </aside>
          </section>
          <section>
            <h4>Now you try! HelloBlock.php</h4>
            <ul>
              <li>alter the block form</li>
              <pre class="fragment"><code class="php">
public function blockForm($form, &$form_state) {
  $form['person'] = array(
    '#type' => 'textfield',
    '#title' => t('Person'),
    '#maxlength' => 50,
    '#default_value' => $this->configuration['person'],
    '#required' => TRUE,
  );
  return $form;
}
              </code></pre>
              <li>alter submit to save</li></ul>
            <pre class="fragment"><code class="php">
public function blockSubmit($form, &$form_state) {
  $this->configuration['person'] = $form_state['values']['person'];
}
            </code></pre>
            <aside class="notes">
              enable drupalgotchi module<br/>
              place HelloBlock<br/>
              then back to this slide<br/>
            </aside>
          </section>
          <section>
            <h4>now you try!  HelloBlock.php</h4>
            <ul>
              <li>create the render array</li>

            <pre class="fragment"><code class="php">
public function build() {
  return array(
    '#theme' => 'hellodrupal_hello_block',
    '#person' => $this->configuration['person'],
  );
}
            </code></pre>
            <li>create the template file</li>

            <pre class="fragment"><code class="php">
hellodrupal/templates/hellodrupal-hello-block.html.twig

---

<p>
{% trans %}
  Hello there {{ person }}!
{% endtrans %}
</p>
            </code></pre>
            </ul>
          </section>
          <section>
            <h4>Now you try! HelloBlock</h4>
            <ul>
            <li>notify the theme about your new template file</li>
            <pre class="fragment"><code class="php">
function hellodrupal_theme() {
  return array(
    'hellodrupal_hello_block' => array(
      'variables' => array('person' => NULL),
      'template' => 'hellodrupal-hello-block',
    )
  );
}
            </code></pre>
</ul>
          </section>
        </section>
<!-- Robin's Plugins Slides End -->
<!-- Robin's Forms -->
        <section><h2>Drupalgotchi!</h2></section>
        <section>
          <section>
            <h2>Forms</h2>
          </section>
          <section>
            <h2>Forms</h2>
            <p>Let's go!</p>
            <p>Create Admin Settings</p>
            <p>Here's how</p>
            <aside class="notes">
              LetÔøΩs get into it right away<br/>
              show the admin setting in your site<br/>
              i need config settings for my module...<br/>
              something an admin can maniuplate via the UI.<br/>
            </aside>
          </section>
          <section>
            <h2>Settings Form Need</h2>
            <ul>
              <li>a route</li>
              <li>config schema</li>
              <li>default values</li>
              <li>a form that extends SystemConfigFormBase</li>
              <li>hook_menu() so it can be visible in navigation</li>
            </ul>
            <aside class="notes">
            you need a route<br/>
            you need a settings schema<br/>
            you probably want default setting values<br/>
            you need form that extends SystemConfigFormBase<br/>
          </section>
          <section>
            <h2>Route to the form</h2>
            <pre><code class="yml">
drupalgotchi/drupalgotchi.routing.yml

---

drupalgotchi_settings:
  pattern: '/admin/config/system/drupalgotchi'
  defaults:
    _form: '\Drupal\drupalgotchi\Form\SettingsForm'
  requirements:
    _permission: 'administer drupalgotchi'

            </code></pre>
          </section>
          <section>
            <h2>Configuration Schema</h2>
            <pre><code class="php">
drupalgotchi/config/schema/drupalgotchi.settings.yml

---

# Schema for the configuration files of the Action module.

drupalgotchi.settings:
  type: mapping
  label: 'Drupalgotchi settings'
  mapping:
    name:
      type: string
      label: "The name of your site's persona"
    needy:
      type: integer
      label: 'How needy your site is'
            </code></pre>
          </section>
          <section>
            <h2>Default Values for Settings</h2>
            <p>same file name, different location</p>
            <pre><code class="php">
drupalgotchi/config/drupalgotchi.settings.yml

---

needy: 10
name: ''

            </code></pre>
          </section>
          <section>
            <h2>SystemConfigFormBase</h2>
            <p>Note how the __construct() uses ConfigFactory</p>
            <pre><code class="php">
drupalgotchi/lib/Drupal/drupalgotchi/Form/SettingsForm.php

---

class SettingsForm extends SystemConfigFormBase {

  protected $config;

  public function __construct(Config $config) {
    $this->config = $config;
  }

  public static function create(ContainerInterface $container) {
    return new static(
      $container->get('config.factory')->get('drupalgotchi.settings')
    );
  }

  public function getFormID() {
    return 'drupalgotchi_settings';
  }

            </code></pre>
            <aside class="notes">
              Form extends SystemConfigFormBase
              ConfigFactory lets us have a schema and default values<br/>
            </aside>
          </section>
          <section>
            <h3>SettingsForm (continued)</h3>
            <pre><code class="php">
drupalgotchi/lib/Drupal/drupalgotchi/Form/SettingsForm.php

---

  public function buildForm(array $form, array &$form_state) {

    $form['name'] = array(
      '#title' => t('Name'),
      '#description' => t('What is your site animal\'s name?'),
      '#type' => 'textfield',
      '#default_value' => $config->get('name'),
    );

    $form['needy'] = array(
      '#title' => t('Neediness'),
      '#description' => t('How needy the site is for attention. Range is from 1-10.'),
      '#type' => 'range',
      '#step' => 1,
      '#min' => 1,
      '#max' => 10,
      '#default_value' => $config->get('needy'),
    );

    return parent::buildForm($form, $form_state);
  }
            </code></pre>
            <aside class="notes">
              machine name in getFormID() - easy enough<br/>
              buildForm (don't those args look familiar?!)<br/>
              and look at that $form array...we can handle that!<br/>
              now we see the power of the configFactory in submitForm<br/>
              set the values and call save()<br/>
            </aside>
          </section>
          <section>
            <h3>SettingsForm</h3>
            <pre><code class="php">
drupalgotchi/lib/Drupal/drupalgotchi/Form/SettingsForm.php

---

  public function submitForm(array &$form, array &$form_state) {
    parent::submitForm($form, $form_state);

    $config->set('name', $form_state['values']['name']);
    $config->set('needy', $form_state['values']['needy']);

    $config->save();
  }
} // end of class
            </code></pre>

          </section>
          <section>
            <h2>now, you try!</h2>
          </section>
          <section>
            <h2>Forms and Config</h2>
            <ul>
              <li>FormInterface</li>
              <ul>
                <li>build</li>
                <li>validate</li>
                <li>submit</li>
              </ul>
              <li>Admin settings use case</li>
            </ul>
            <aside class="notes">
              forms now rely in the FormInterface<br/>
              build, validate, submit -
              pretty straightforward and all in one place!  easy to read!<br/>
              system settings have a special use case where the form can rely on module configuration<br/>
              switch to netbeans and click through classes and interfaces
            </aside>
          </section>
        </section>
<!-- Robin's Form Slides End -->
<!-- Robin's Config Slides -->
        <section>
          <section>
            <h2>Configuration Management</h2>
          </section>
          <section>
            <h2>Configuration Management (CMI)</h2>
            <ul>
              <li>Configuration is everything users and editors do not write</li>
              <li>It's translatable</li>
              <li>Usual Suspects:</li>

              <ul>
                <li>views</li>
                <li>view modes</li>
                <li>image styles</li>
                <li>perms</li>
                <li>content types</li>
                <li>settings</li>
              </ul>
            </ul>
          </section>
          <section>
            <h2>Config:  It's in the Files!</h2>
            <ul>
              <li>elminated 50 tables from the drupal db</li>
              <li>writes directly to files not the db</li>
              <li>written in yml, not too hard to write/read and maps to arrays</li>
            </ul>
            <pre><code class="php">
base_field: nid
base_table: node
core: 8.x
description: 'Find and manage content.'
status: '1'
display:
  default:
    display_options:
      access:
        type: perm
        options:
          perm: 'access content overview'
      cache:
        type: none
      query:
        type: views_query
      exposed_form:
        type: basic
        options:
          submit_button: Filter
          reset_button: '0'
          reset_button_label: Reset
          exposed_sorts_label: 'Sort by'
              </code></pre>
            <aside class="notes">
              what does this yml snippet look like to you?<br/>
              new line characters denote end of value<br/>
              indenting allows for more complex data structures<br/>
              note the use of single quotes!  different from Annotations<br/>
              more to add here!!! @todo
            </aside>
          </section>
          <section>
            <h2>Configuration Schema</h2>
            <ul>
              <li>Defines structure for config yml files</li>
              <li>first line is the ID of the config</li>
              <li>mapping:  define key-value pairs for your config</li>
              <li>'label' and 'text' are two built-in types which are translatable</li>
              <li>Learn more:  <a href="https://drupal.org/node/1905070">https://drupal.org/node/1905070</a></li>
            </ul>
            <pre><code class="php">
drupalgotchi.settings:  # config ID
  type: mapping
  label: 'Drupalgotchi settings'
  mapping:
    name:
      type: string
      label: "The name of your site's persona"
    needy:
      type: integer
      label: 'How needy your site is'
            </code></pre>
            <aside class="notes">
              primary use case:  for translation<br/>
              The built-in translatable types are 'label' for one-line text input and 'text' for multiline text input.<br/>
              but also for forms<br/>
              forms make the types more important in the mapping seciton<br/>
            </aside>
          </section>
          <section>
            <h2>Settings and Configuration</h2>
            <ul>
              <li>Replaces the variable table</li>
              <li>now each module's <em>status</em> is in yml!</li>
              <li>System table is gone</li>
              <li>Configuration and state</li>
              <li>pluggable storage:  config could be in memcache</li>
            </ul>
            <aside class="notes">
              replaces variable table<br/>
              enabled status of modules is in config<br/>
              system table is gone<br/>
              split between configuration and state<br/>
              Larry will talk more about this?(or did he already?)<br/>
              has pluggable storage<br/>
              even cmi so if you want to put your config in memcache you can do that<br/>
            </aside>
          </section>
          <section>
            <h2>Configuration and Multiple Environments</h2>
            <p>Storage</p>
            <pre><code class="php">
sites/default/files/config_[hash]

e.g.

config_MUJZBWAhPUGAfz9XAEdGOc0Lk-zG-AcMKG8iOZwRUZE/

---
sites/default/files/config_[hash]/
  active/
  staging/

---
settings.php

$config_directories['active']['path'] = 'config_[hash]/active';
$config_directories['staging']['path'] = 'config_[hash]/staging';
            </code></pre>
            <aside class="notes">
              my slipper slope slide!<br/>
            Configuration Storage and Multiple Environments<br/>
a directory is created in sites/default/files/config_[randomized_hash] <br/>
hash protects the files (obfuscation)<br/>
different per instance e.g. different for each person who installs<br/>
best practice:  store outside of your web root<br/>
active - what's live on the site<br/>
staging - config thats new that you want to import into the site<br/>
deployment from source active dir to your destination staging dir<br/>
set which is directory is active in settings.php<br/>
so you point to the opposite directories between the dev environment and production environments<br/>
production active dir is staging<br/>
dev active dir is active<br/>
make changes to active dir on dev<br/>
no rollback<br/>
can't move the files as is, becuase you could clash with a change coming from a user via the UI<br/>
            </aside>
          </section>
        </section>
<!-- Robin's Config Slides End -->
        <section>
          <section>
            <h2>Events</h2>
            <p class="fragment roll-in">Not the kind with dates</p>
          </section>
          <section>
            <h2>Events</h2>
            <ul>
              <li class="fragment">Like hooks, but OO</li>
              <li class="fragment">Less magic, more explicit</li>
              <li class="fragment">Should also be simple bridge code, mostly</li>
            </ul>
          </section>
          <section>
            <h2>Events</h2>
            <ul>
              <li class="fragment"><em>Event</em>: thing that happens</li>
              <li class="fragment"><em>Listener</em>: Code that responds to an event</li>
              <li class="fragment"><em>Dispatcher</em>: Mediator of all event responding</li>
              <li class="fragment"><em>Subscriber</em>: A class/service containing listeners</li>
            </ul>
          </section>

          <section>
            <pre><code class="php">
class DrupalgotchiSubscriber implements EventSubscriberInterface {

  public function onKernelRequestSetHappiness(GetResponseEvent $event) {
    if ($event->getRequestType() != KernelInterface::MASTER_REQUEST) {
      return;
    }

    $request = $event->getRequest();
    // Do stuff.
  }

  public function onKernelRequestShowHappiness(GetResponseEvent $event) {
  }

  public static function getSubscribedEvents() {
    $events[KernelEvents::REQUEST][] = array('onKernelRequestSetHappiness', 5);
    $events[KernelEvents::REQUEST][] = array('onKernelRequestShowHappiness', 2);
    return $events;
  }

}
</code></pre>
            <aside class="notes">
              <ul>
                <li>Multiple listener methods in one subscriber</li>
                <li>Could be any callable, but we use entirely subscribers</li>
                <li>Could be any events; we have a few outside of the kernel, not many</li>
                <li>stopPropagation() (also triggered by some other methods, like setResponse())</li>
                <li>Contrib SHOULD start defining events, not hooks.</li>
              </ul>
            </aside>
          </section>
          <section>
            <h2>mymodule.services.yml</h2>
            <pre class="long_code"><code class="yaml">services:
  drupalgotchi.subscriber:
    class: Drupal\drupalgotchi\EventSubscriber\DrupalgotchiSubscriber
    arguments: ['@config.factory', '@state', '@string_translation']
    tags:
      - { name: event_subscriber }
</code></pre>
          </section>
          <section>
            <h2>Your turn</h2>
            <aside class="notes">
              Add a listener that increments or decrements the happiness state
              on every page request, depending on who the user is.
            </aside>
          </section>
        </section>


<!-- Robin's Entity Slides -->
        <section>
          <section>
           <h2>Entities</h2>
          </section>
          <section>
            <h2>New and Improved Entity API</h2>
            <p>properties and fields are all &quot;fields&quot;</p>
            <p>fields are handled the same way. </p>
            <pre><code class="php">
$node->get('field_tags')->value

---

returns term id e.g.

1
            </code></pre>
            <aside class="notes">
              entity API has been revamped in D8<br/>
              All properties on an entity is a ÔøΩfieldÔøΩ not configurable otherwise treaed like other fields<br/>
              Accessing fields occurs the same way for all properties<br/>
              e.g. get first value in field_tags
              can access primitives using ->get(ÔøΩvalueÔøΩ) or use $node->title[$delta]->value<br/>
              Review EntityInterface<br/>
              entityNG - for existing entities like node and comment (temporary)<br/>
              entity - one example:  MenuLink.php (plus MenuLinkInterface)<br/>
            </aside>
          </section>
          <section>
            <h2>Entity References:  Lazy load</h2>
            <p>Get the first item in the refence field:</p>
            <pre><code class="php">
$node->get('field_tags')->entity->name->value

---

returns term name e.g.

drupal 8
            </code></pre>
            <aside class="notes">
              Lazy load entity references<br/>
                $entity->user_ref->entity->name->value<br/>
                references the first value in the ref field<br/>
            </aside>
          </section>
          <section>
            <h2>Entities and Fields</h2>
            <p>Introspection:  you call a method to get the &quot;field&quot; definitions</p>
            <p>Computed fields:  lookup or calculate value (instead of store)</p>
            <p>EntityInterface</p>
            <aside class="notes">
              and $delta supports multi-value<br/>
              Introspection capabilities are built in the Entity and Property objects: call a method to get
                the definitions of the contained properties.<br/>
              Computed fields:  ability to lookup or otherwise calculate a value rather than returning a stored value<br/>
            </aside>
          </section>
        </section>
<!-- Robin's Entity Slides End -->
<!-- Robin's Theming Slides -->
        <section>
          <section>
            <h2>Theming in D8</h2>
          </section>
          <section>
            <h2>Theming Basics</h2>
            <p>It's twig!</p>
            <ul>
              <li>{...} for printing a variable: {{ variable_name }}</li>
              <li>drill down using '.': {{ node.title }}</li>
              <li>comments:  {# comments #}</li>
              <li>php code (whitelisted):  {% hide(content.field_example) %}</li>
              <li>inheritance:  {% block twig_block_name %}</li>
            </ul>
          </section>
          <section>
            <h2>Twig Filters</h2>
            <ul>
              <li>a function for manipulating values</li>
              <li>escape - safe strings:  {{ varname|escape('html') }}</li>
              <li>upper - all uppercase:  {{ 'welcome'|upper }}</li>
              <li>Built-in filters are availble</li>
              <li><a href="http://twig.sensiolabs.org/doc/filters/index.html">http://twig.sensiolabs.org/doc/filters/index.html</a></li>
            </ul>
          </section>
          <section>
            <h2>Theme Setup</h2>
            <p>Custom themes go in themes/ directory (Drupal root)</p>
            <p>Jen Lampton's twiggy:</p>
            <p><a href="https://github.com/jenlampton/twiggy">https://github.com/jenlampton/twiggy</a></p>
            <p>Enable, then Set default</p>
            <aside class="notes">
              Enable and Set as Default - was failing for me<br/>
              Inheritance (infoblock):  show node.html.twig and node--article.html.twig<br/>
            </aside>
          </section>
        </section>
<!-- Robin's Theming Slides End -->
<!-- Ken's testing slides -->
        <section>
          <section>
          <h1>Testing</h1>
          <p class="fragment"><code>git checkout 06-tests</code></p>
          </section>
          <section>
            <h2>Why test?</h2>
            <ul>
              <li class="fragment">Ensure functionality</li>
              <li class="fragment">Code planning and refactoring</li>
              <li class="fragment">Continuous integration</li>
              <li class="fragment">Get better sleep!</li>
            </ul>
          </section>
          <section>
            <h2>Test methods</h2>
            <ul>
              <li class="fragment">Drupal 7: SimpleTest</li>
              <li class="fragment">Drupal 8: SimpleTest</li>
              <li class="fragment">Drupal 8: PHPUnit</li>
            </ul>
          </section>
          <section>
            <h2>Test standards</h2>
            <ul>
              <li class="fragment">Unit testing
                <ul>
                  <li class="fragment">Does the code behave as expected?</li>
                  <li class="fragment">Does the code work in isolation?</li>
                  <li class="fragment">Does the code do too much?</li>
                  <li class="fragment">PHP Unit</li>
                </ul>
              </li>
              <li class="fragment">Integration testing
                <ul>
                  <li class="fragment">Is the output as expected?</li>
                  <li class="fragment">Does it play well with others?</li>
                  <li class="fragment">What does it do in the browser?</li>
                  <li class="fragment">SimpleTest</li>
                </ul>
              </li>
            </ul>

          </section>
          <section>
            <h2>Test cases</h2>
            <pre><code class="php">class HelloBlock extends BlockBase {

  public function build() {
    return array(
      '#theme' => 'drupalgotchi_hello_block',
      '#person' => $this->configuration['person'],
    );
  }

}            </code></pre>
            <ul>
              <li class="fragment"><code>lib/Drupal/drupalgotchi/Plugin/Block/HelloBlock.php</code></li>
              <li class="fragment"><code>lib/Drupal/drupalgotchi/Tests/HelloBlockTest.php</code></li>
              <li class="fragment"><code>tests/Drupal/drupalgotchi/Tests/Plugin/Block/HelloBlockTest.php</code></li>
            </ul>
          </section>
          <section>
            <h3>Simpletest: HelloBlock.php</h3>
            <pre class="long_code"><code class="php">/**
 * @file
 * Contains \Drupal\drupalgotchi\Tests\HelloBlockTest.
 */

namespace Drupal\drupalgotchi\Tests;
use Drupal\drupalgotchi\Plugin\Block\HelloBlock;
use Drupal\simpletest\WebTestBase;

/**
 * Tests the Drupalgotchi Hello block.
 */
class HelloBlockTest extends WebTestBase {
  // Enable dependencies.
  public static $modules = array('drupalgotchi', 'block');

  public static function getInfo() {
    return array(
      'name' => 'Drupalgotchi hello block',
      'description' => 'Interface test for the hello block',
      'group' => 'Drupalgotchi',
    );
  }
}           </code></pre>
          </section>
          <section>
            <h3>Simpletest: HelloBlock.php</h3>
            <pre class="long_code"><code class="php">

  public function testHelloBlock() {
    // Go to the home page.
    $this->drupalGet('');

    // Block text should not be present.
    $this->assertNoText('Drupalgotchi Hello', 'Block title not found.');
    $this->assertNoText('Hello there World!', 'Block text not found.');

    // Place the block.
    $settings = array('label' => 'Drupalgotchi Hello');
    $this->drupalPlaceBlock('drupalgotchi_hello', $settings);

    // Go to the home page.
    $this->drupalGet('');

    // Block text should be present.
    $this->assertText('Drupalgotchi Hello', 'Block title found.');
    $this->assertText('Hello there World!', 'Block text found.');

  }

            </code></pre>
          </section>
          <section>
            <h3>PHPUnit: HelloBlock.php</h3>
            <pre class="long_code"><code class="php">
/**
 * @file
 * Contains \Drupal\drupalgotchi\Tests\Plugin\Block\HelloBlockTest.
 */

namespace Drupal\drupalgotchi\Tests\Plugin\Block;

use Drupal\Tests\UnitTestCase;
use Drupal\drupalgotchi\Plugin\Block\HelloBlock;

/**
 * Tests the Drupalgotchi hello block.
 */
class HelloBlockTest extends UnitTestCase {

  public static function getInfo() {
    return array(
      'name' => 'Drupalgotchi hello block plugin',
      'description' => 'Tests the Drupalgotchi hello block',
      'group' => 'Drupalgotchi',
    );
  }
            </code></pre>
          </section>
          <section>
            <h3>PHPUnit: HelloBlock.php</h3>
            <pre class="long_code"><code class="php">
  protected function setUp() {
    parent::setUp();
    // Autoloading is not working for contrib. Load our class to test.
    // See https://drupal.org/node/2025883
    include_once DRUPAL_ROOT . '/modules/drupalgotchi/lib/Drupal/
      drupalgotchi/Plugin/Block/HelloBlock.php';
  }

  public function testBlock() {
    $config = array();
    $plugin = array('module' => 'drupalgotchi', 'id' => 'drupalgotchi_hello');
    $block_plugin = new HelloBlock($config, 'drupalgotchi_hello', $plugin);

    $build = $block_plugin->build();
    $this->assertEquals('drupalgotchi_hello_block', $build['#theme']);
    $this->assertEquals('World', $build['#person']);
  }
            </code></pre>
          </section>
          <section>
            <h2>Differences in approach</h2>
              <ul>
                <li class="fragment">SimpleTest requires the whole system</li>
                <li class="fragment">PHPUnit only tests our class</li>
                <li class="fragment">SimpleTest assesses the result</li>
                <li class="fragment">PHPUnit introspects the behavior</li>
                <li class="fragment">Simpletest declares dependencies</li>
                <li class="fragment">PHPUnit injects dependencies</li>
              </ul>
          </section>
          <section>
            <h2>Dependency injection</h2>
              <p class="fragment"><small>In under two minutes</small></p>
              <p class="fragment">Remember: An object on which your object depends</p>
              <br /><br />
              <p class="fragment"><code>git checkout 07-di-tests</code></p>
              <ul>
                <li class="fragment"><code>lib/Drupal/drupalgotchi/Plugin/Action/SetDrupalgotchi.php</code></li>
                <li class="fragment"><code>tests/Drupal/drupalgotchi/Tests/Plugin/Action/SetDrupalgotchiTest.php</code></li>
              </ul>
          </section>
          <section>
            <h3>SetDrupalgotchi.php</h3>
            <pre class="long_code"><code class="php">
class SetDrupalgotchi extends ActionBase implements ContainerFactoryPluginInterface {

  protected $state;

  public function __construct(array $configuration, $plugin_id,
    array $plugin_definition, KeyValueStoreInterface $state) {

    parent::__construct($configuration, $plugin_id, $plugin_definition);
    $this->state = $state;
  }

  public function execute($attention = 0) {
    $this->state->set('drupalgotchi.attention', $attention);
  }
}           </code></pre>
          </section>
          <section>
            <h3>SetDrupalgotchi.php</h3>
            <pre class="long_code"><code class="php">
  public function __construct(
    array $configuration,
    $plugin_id,
    array $plugin_definition,
    KeyValueStoreInterface $state) {
  }

  ...

  $state = new KeyValueStore();
  $gotch = new SetDrupalgotchi(
    $configuration,
    $plugin_id,
    $plugin_definition,
    $state
  );
            </code></pre>
          </section>

          <section>
            <h3>PHPUnit: SetDrupalgotchi.php</h3>
            <pre class="long_code"><code class="php">
namespace Drupal\drupalgotchi\Tests\Plugin\Action;

use Drupal\Tests\UnitTestCase;
use Drupal\drupalgotchi\Plugin\Action\SetDrupalgotchi;

class SetDrupalgotchiTest extends UnitTestCase {

  protected $state;

  public static function getInfo() {
    return array(
      'name' => 'Drupalgotchi action plugin',
      'description' => 'Tests the set Drupalgotchi plugin',
      'group' => 'Drupalgotchi',
    );
  }
            </code></pre>
          </section>
          <section>
            <h3>PHPUnit: SetDrupalgotchi.php</h3>
            <pre class="long_code"><code class="php">
  public function testSet() {

    $config = array('name' => 'foo', 'needy' => 10);
    $set = new SetDrupalgotchi(
      $config,
      'drupalgotchi_set_attention',
      array(),
      $state
    );

    $set->execute(10);

  }
            </code></pre>
          </section>
          <section>
            <h2>Mocks</h2>
            <ul>
              <li class="fragment">Mock objects that your code is <strong style="color:#fff;">not testing</strong></li>
              <li class="fragment">PHPUnit syntax and code support.</li>
              <li class="fragment">Inject dependencies</li>
              <li class="fragment">Define expected <strong style="color: #fff;">external</strong> behaviors</li>
              <li class="fragment">See <a href="http://phpunit.de/manual/current/en/test-doubles.html">http://phpunit.de/manual/current/en/test-doubles.html</a></li>
            </ul>
            <br /><br />
            <p class="fragment"><code>git checkout 06-tests</code></p>
          </section>
          <section>
            <h3>PHPUnit: SetDrupalgotchi.php</h3>
            <pre class="long_code"><code class="php">
  public function testSet() {

    // Set a mock class (a "stub") for the state container.
    // See http://phpunit.de/manual/current/en/test-doubles.html
    $state = $this
      ->getMockBuilder('Drupal\Core\KeyValueStore\KeyValueStoreInterface')
      ->getMock();
    // Configure the stub to get the values passed by execute().
    $state->expects($this->once())
      ->method('set')
      ->with($this->equalTo('drupalgotchi.attention', 10));

    $config = array('name' => 'foo', 'needy' => 10);
    $set = new SetDrupalgotchi(
      $config,
      'drupalgotchi_set_attention',
      array(),
      $state
    );

    $set->execute(10);

  }
            </code></pre>
          </section>
          <section>
            <h2>Using Mocks</h2>
            <ul>
              <li class="fragment">Import your dependencies as mocks</strong></li>
              <li class="fragment">Set expectations for method calls</li>
              <li class="fragment">Can mock classes or interfaces</li>
              <li class="fragment"><code>disableOriginalConstructor()</code>
                <uL>
                  <li class="fragment">Will not call <code>__construct() on the mocked object</code></li>
                  <li class="fragment">Useful for reducing complexity</li>
                </ul>
              </li>

            </ul>
          </section>
          <section>
            <h2>Mock pattern</h2>
            <ul>
              <li class="fragment"><code>$mock = $this->getMockBuilder('MyClass')</code>
                <ul>
                  <li class="fragment">->disableOriginalConstructor()</li>
                  <li class="fragment"><code>->getMock();</code></li>
                </ul>
              </li>
              <li class="fragment"><code>$mock->expects($this->CONDITION())</code>
                <ul>
                  <li class="fragment"><code>->method('myMethod')</code>
                    <ul>
                      <li class="fragment"><code>->will($this->DOSOMETHING())</code></li>
                      <li class="fragment"><code>->with($this->ASSERTION())</code></li>
                    </ul>
                </li>
              </li>
            </ul>
          </section>
          <section>
            <h2>Common <code>will()</code> methods</h2>
            <ul>
              <li class="fragment"><code>will($this->returnValue('foo'))</code>
                <uL>
                  <li>Returns expected value from declared method.</li>
                </ul>
              </li>
              <li class="fragment"><code>will($this->returnArgument(1))</code>
                <uL>
                  <li>Returns passed argument without change.</li>
                </ul>
              </li>
              <li class="fragment"><code>will($this->returnSelf())</code>
                <uL>
                  <li>Returns the mocked object.</li>
                </ul>
              </li>
              <li class="fragment"><code>will(returnCallback('str_rot13'))</code>
                <uL>
                  <li>Returns a value after processing through a callback function.</li>
                </ul>
              </li>
            </ul>
          </section>
          <section>
            <h2>Common <code>with()</code> methods</h2>
            <ul>
              <li class="fragment"><code>with($this->equalTo('foo'))</code>
                <uL>
                  <li>Checks method argument is 'foo'.</li>
                </ul>
              </li>
              <li class="fragment"><code>with($this->equalTo('foo', 'bar'))</code>
                <uL>
                  <li>Checks method arguments are 'foo' and 'bar'.</li>
                </ul>
              </li>
              <li class="fragment"><code>with($this->greaterThan(5))</code>
                <uL>
                  <li>Checks assertion against passed argument.</li>
                </ul>
              </li>
              <li class="fragment">You can pass any PHPUnit assertion.</li>
              <li class="fragment">You can assert against each argument for the method.</li>
            </ul>
          </section>
          <section>
            <h2>Your Turn!</h2>
            <ul>
              <li class="fragment">SimpleTest: DrupalgotchiBlockTest.php</li>
              <li class="fragment">PHPUnit: DrupalgotchiBlockTest.php</li>
            </ul>
          </section>
          <section>
            <h2>Hints</h2>
            <pre><code>
drupalgotchi/
  lib/
    Drupal/
      drupalgotchi/
        Tests/
          DrupalgotchiBlockTest.php

drupalgotchi/
  tests/
    Drupal/
      drupalgotchi/
        Tests/
          Plugin/
            Block/
              DrupalgotchiBlockTest.php
            </code></pre>
          </section>
          <section>
            <h3>Hints</h3>
            <pre><code class="php">/**
 * @file
 * Contains \Drupal\drupalgotchi\Tests\DrupalgotchiBlockTest.
 */

namespace Drupal\drupalgotchi\Tests;

use Drupal\drupalgotchi\Plugin\Block\DrupalgotchiBlock;
use Drupal\simpletest\WebTestBase;

/**
 * Tests the Drupalgotchi block.
 */
class DrupalgotchiBlockTest extends WebTestBase {

  /**
   * Modules to enable.
   *
   * @var array
   */
  public static $modules = array('drupalgotchi', 'block');

  public function getinfo();
  public function testDrupalgotchiBlock();

}

            </code></pre>
          </section>
          <section>
            <h3>Hints</h3>
            <pre class="long_code"><code class="php">/**
 * @file
 * Contains \Drupal\drupalgotchi\Tests\Plugin\Block\DrupalgotchiBlockTest.
 */

namespace Drupal\drupalgotchi\Tests;

use Drupal\drupalgotchi\Plugin\Block\DrupalgotchiBlock;
use Drupal\Tests\UnitTestCase;

/**
 * Tests the Drupalgotchi block.
 */
class DrupalgotchiBlockTest extends UnitTestCase {

  public function getinfo();
  public function setup();
  public function testDrupalgotchiBlock();

}

            </code></pre>
          </section>
        </section>
<!-- Ken's testing slides end -->
<!-- Wrap up slides -->
        <section>
          <section>
            <h1>Review and wrap-up</h1>
            <h2 style="margin-top: 1em;">Key take-aways</h2>
          </section>
          <section>
            <h3>Think in loosely coupled objects,<br />not just loosely coupled modules</h3>
            <aside class="notes">
              <ul>
                <li></li>
              </ul>
            </aside>
          </section>
          <section>
            <h3>Separate business logic from glue code</h3>
            <aside class="notes">
              <ul>
                <li></li>
              </ul>
            </aside>
          </section>
          <section>
              <h3>Unit Tests or it didn't happen</h3>
            <aside class="notes">
              <ul>
                <li></li>
              </ul>
            </aside>
          </section>
          <section>
            <h3>Display logic happens<br />at the display layer</h3>
            <aside class="notes">
              <ul>
                <li>Twig does way more than PHPTemplate ever did</li>
                <li>Let it do it; Keep your themers happy</li>
              </ul>
            </aside>
          </section>
          <section>
            <h2 style="color: #a31; font-size: 256px; text-shadow: 1px 1px 1px #800;">Don't Panic</h2>
          </section>
          <section>
            <h3>The future is a very different place</h3>
            <h3 class="fragment roll-in">But a really cool one</h3>
            <h3 class="fragment roll-in">(Always bring your towel)</h3>
            <aside class="notes">
              <ul>
                <li></li>
              </ul>
            </aside>
          </section>
          <section>
            <h2>Survey</h2>
            <ul>
              <li class="fragment">How did we do?</li>
              <li class="fragment">Check your email, please.</li>
              <li class="fragment">$10 Amazon gift cards upon completion!</li>
            </ul>
          </section>
          <section>
            <h2>Thank you!</h2>
            <p>See you online!</p>
            <ul>
              <li><a href="http://www.twitter.com/agentrickard">@agentrickard</a></li>
              <li><a href="http://www.twitter.com/Crell">@Crell</a></li>
              <li><a href="http://www.twitter.com/robinbarre">@RobinBarre</a></li>
            </ul>
        </section>
      </div><!-- end div for all slides -->

      <aside class="logo">
      <img src="img/logo.png">
      </aside>

    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.min.js"></script>

    <script>

      // Full list of configuration options available here:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,

        theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
        transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none

        // Optional libraries used to extend on reveal.js
        dependencies: [
          { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
          { src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
          { src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
          // { src: 'plugin/search/search.js', async: true, condition: function() { return !!document.body.classList; } }
          // { src: 'plugin/remotes/remotes.js', async: true, condition: function() { return !!document.body.classList; } }
        ]
      });

    </script>

  </body>
</html>
